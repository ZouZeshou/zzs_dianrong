# 概述

* 超级电容控制板程序，使用芯片为STM32F405RGTx

## 软件环境

* IDE：MDK-ARM V5
* package version: STM32Cube FW_F4 V1.24.0

## 配置

* 晶振24MHz,AHB时钟配为168MHz

* I/O:

  | I/O  | function      | mode             | 备注             |
  | ---- | ------------- | ---------------- | ---------------- |
  | PA7  | relay(继电器) | output push pull |                  |
  | PB6  | LED           | output push pull |                  |
  | PA4  | ADC1_IN4      | analog mode      | 充电电流         |
  | PA6  | ADC1_IN6      | analog mode      | 放电电流         |
  | PC5  | ADC1_IN15     | analog mode      | 底盘电流         |
  | PA5  | ADC2_IN5      | analog mode      | 电容电压         |
  | PB8  | CAN1_RX       | 复用             | 用于与机器人通讯 |
  | PB9  | CAN1_TX       | 复用             |                  |
  | PA0  | TIM2_CH1      | 复用             | 控制充电的PWM    |
  | PA1  | TIM5_CH2      | 复用             | 控制放电的PWM    |
  | PA2  | USART2_TX     | 复用             | 调试串口         |
  | PA3  | USART2_RX     | 复用             |                  |

## 数据交互

#### 通过can总线直接接受裁判系统信息，包括：

- 底盘电压`
- 底盘电流`
- 底盘功率
- 缓冲池
- 伤害类型

#### 通过ADC_DMA中断采集电容相关参数：

##### ADC1（通用）：

- 充电电流/放电电流（300kHz）
- 底盘电流（300kHz）

##### ADC2（充电）：

- 电容电压（100Hz）

## 运行流程

#### 主程序流程在定时器中断中运行

- TIM2（充电）：触发频率为10kHz，运行电容充电控制程序
- TIM3（通用）：触发频率300kHz，用于ADC1采集数据
- TIM6（通用）：触发频率1Hz,调试打印
- TIM8（充电）：触发频率100Hz,用于ADC2采集数据，通过CAN总线发送电容电压以及电容是否处于可用状态
- TIM5（放电）:  触发频率为1000Hz,运行电容放电控制程序

#### 流程图：

![](D:\respotory\zzs_dianrong\超级电容.png)

## 调试流程

1. 电容真实电压校准：采用电压表校准
2. 充电电流校准：电流采样 采集一千次得到的零点偏置值, 用来标定
3. 底盘电流校准：电流采样 采集一千次得到的零点偏置值, 用来标定
4. 底盘功率校准（由于裁判系统返回数据频率较低，所以采用采样的电流值*裁判系统电压值作为实时功率）：在充电过程中观察裁判系统数据来校准
5. 调节pid

#### 快速开始

- 将程序烧写进控制板后接好线
- 测量电容真实电压与采样得到电压，微调系数
- 在充电和放电的过程中，观察充电/放电功率与程序内设定功率的差距，调节偏移系数以及斜率
- 底盘功率最后微调即可

